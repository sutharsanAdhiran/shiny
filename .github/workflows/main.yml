name: Build and Deploy to Posit Connect

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Get the code from your repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Node.js (Version 22 for Vite 7 compatibility)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 3. Build the Vite React Frontend
      - name: Vite Build
        run: |
          cd react
          npm install
          npm run build

      # 4. Sync Assets and Inject Filenames into app.py
      - name: Inject Vite Assets into app.py
        run: |
          # Clean and prepare the www folder
          mkdir -p www/assets
          rm -rf www/assets/*
          
          # Move build results to the static folder
          cp -r react/dist/* www/
          
          # Find the new hashed filenames
          JS_FILE=$(ls www/assets/index-*.js | xargs -n 1 basename)
          CSS_FILE=$(ls www/assets/index-*.css | xargs -n 1 basename)
          
          echo "Found JS Bundle: $JS_FILE"
          echo "Found CSS Bundle: $CSS_FILE"
          
          # Replace placeholders in app.py
          sed -i "s/REPLACE_ME_JS/$JS_FILE/g" app.py
          sed -i "s/REPLACE_ME_CSS/$CSS_FILE/g" app.py

      # 5. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # 6. Register Server and Deploy
      - name: Deploy to Posit Connect
        env:
          CONNECT_SERVER: "https://your-server-url.com"
          CONNECT_API_KEY: "your-api-key-here"
        run: |
          python -m pip install --upgrade pip
          pip install rsconnect-python shiny
          
          # Step A: Register the server with a nickname ('production')
          # This avoids the command-line argument conflict you saw
          rsconnect add --server $CONNECT_SERVER --api-key $CONNECT_API_KEY --name production
          
          # Step B: Create the manifest.json
          rsconnect write-manifest shiny . --entrypoint app:app
          
          # Step C: Deploy using the registered server nickname
          # --force ensures it updates the existing app without asking
          rsconnect deploy manifest manifest.json \
            --name "vite-shiny-app-athik" \
            --title "React + Shiny Production" \
            --server production \
            --force
