name: Build MLC Android Libs
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Maximize Build Space & Swap
        run: |
          # Create 8GB swap to prevent OOM crashes during Gemma-2 compilation
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          # Use the pre-release (nightly) wheels from the official MLC server
          python -m pip install --pre -U -f https://mlc.ai/wheels \
            mlc-llm-nightly-cpu \
            mlc-ai-nightly-cpu \
            torch \
            numpy

      - name: Setup Rust
        run: |
          rustup target add aarch64-linux-android

      - name: Locate and Export Android NDK
        run: |
          # Use the stable NDK version provided by the GitHub runner
          # We use the ANDROID_HOME environment variable to find the path
          echo "ANDROID_NDK=$ANDROID_HOME/ndk-bundle" >> $GITHUB_ENV
          echo "MLC_LLM_SOURCE_DIR=$(pwd)" >> $GITHUB_ENV

      - name: Build Gemma-2-2B Package
        run: |
          # This command compiles the model for Android GPU (OpenCL)
          # even though we are running on a CPU runner.
          mlc_llm package --model HF://mlc-ai/gemma-2-2b-it-q4f16_1-MLC --device android

      - name: Upload AI Bundle
        uses: actions/upload-artifact@v4
        with:
          name: gemma-android-bundle
          # This folder will contain the .a libraries and the .json config
          path: dist/bundle/
